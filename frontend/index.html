<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚úàÔ∏è Flight Price Predictor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #fff;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            padding: 40px 0;
        }
        
        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        header p {
            color: #a0a0a0;
            font-size: 1.1rem;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
        }
        
        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .card h2 {
            margin-bottom: 25px;
            font-size: 1.4rem;
            color: #00d9ff;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #ccc;
            font-size: 0.9rem;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        input, select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #00d9ff;
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.3);
        }
        
        select option {
            background: #1a1a2e;
            color: #fff;
        }
        
        .checkbox-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            color: #1a1a2e;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 217, 255, 0.4);
        }
        
        .result-card {
            text-align: center;
        }
        
        .price-display {
            background: linear-gradient(135deg, rgba(0, 217, 255, 0.1), rgba(0, 255, 136, 0.1));
            border-radius: 20px;
            padding: 40px;
            margin: 20px 0;
            border: 1px solid rgba(0, 217, 255, 0.3);
        }
        
        .price-label {
            font-size: 1rem;
            color: #a0a0a0;
            margin-bottom: 10px;
        }
        
        .price-value {
            font-size: 3.5rem;
            font-weight: 700;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .price-range {
            margin-top: 15px;
            color: #a0a0a0;
            font-size: 0.95rem;
        }
        
        .factors {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 25px;
        }
        
        .factor-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }
        
        .factor-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }
        
        .factor-label {
            font-size: 0.75rem;
            color: #a0a0a0;
            margin-bottom: 4px;
        }
        
        .factor-value {
            font-size: 0.95rem;
            font-weight: 600;
            color: #00d9ff;
        }
        
        .route-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }
        
        .route-display .airport {
            font-weight: 700;
            color: #fff;
        }
        
        .route-display .arrow {
            color: #00d9ff;
        }
        
        .confidence-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-top: 15px;
        }
        
        .confidence-high {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }
        
        .confidence-medium {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(0, 217, 255, 0.3);
            border-top-color: #00d9ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }
        
        .model-info {
            margin-top: 30px;
            padding: 20px;
            background: rgba(0, 217, 255, 0.1);
            border-radius: 12px;
            font-size: 0.85rem;
            color: #a0a0a0;
        }
        
        .model-info h3 {
            color: #00d9ff;
            margin-bottom: 10px;
            font-size: 1rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
        }
        
        .stat-label {
            color: #888;
        }
        
        .stat-value {
            color: #00ff88;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚úàÔ∏è Flight Price Predictor</h1>
            <p>AI-Powered Dynamic Pricing Engine</p>
        </header>
        
        <div class="main-content">
            <!-- Input Form -->
            <div class="card">
                <h2>üìù Flight Details</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>From Airport</label>
                        <select id="fromAirport">
                            <option value="ATL">ATL - Atlanta</option>
                            <option value="DFW">DFW - Dallas</option>
                            <option value="DEN">DEN - Denver</option>
                            <option value="ORD">ORD - Chicago</option>
                            <option value="LAX">LAX - Los Angeles</option>
                            <option value="CLT">CLT - Charlotte</option>
                            <option value="MIA">MIA - Miami</option>
                            <option value="JFK" selected>JFK - New York</option>
                            <option value="EWR">EWR - Newark</option>
                            <option value="SFO">SFO - San Francisco</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>To Airport</label>
                        <select id="toAirport">
                            <option value="ATL">ATL - Atlanta</option>
                            <option value="DFW">DFW - Dallas</option>
                            <option value="DEN">DEN - Denver</option>
                            <option value="ORD">ORD - Chicago</option>
                            <option value="LAX" selected>LAX - Los Angeles</option>
                            <option value="CLT">CLT - Charlotte</option>
                            <option value="MIA">MIA - Miami</option>
                            <option value="JFK">JFK - New York</option>
                            <option value="EWR">EWR - Newark</option>
                            <option value="SFO">SFO - San Francisco</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Search Date</label>
                        <input type="date" id="searchDate">
                    </div>
                    <div class="form-group">
                        <label>Flight Date</label>
                        <input type="date" id="flightDate">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Seats Remaining</label>
                        <input type="number" id="seatsRemaining" value="5" min="1" max="200">
                    </div>
                    <div class="form-group">
                        <label>Distance (miles)</label>
                        <input type="number" id="distance" value="2475" min="100" max="5000">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Departure Time (Hour)</label>
                        <input type="number" id="departureHour" value="10" min="0" max="23">
                        <small style="color: #666; font-size: 0.85em;">Used for night fare detection (late night/early morning surcharges)</small>
                    </div>
                    <div class="form-group">
                        <label>Number of Segments</label>
                        <input type="number" id="numSegments" value="1" min="1" max="6">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Flight Duration (minutes)</label>
                        <input type="number" id="durationMinutes" value="360" min="30" max="1200">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Carrier</label>
                        <select id="carrier">
                            <option value="AA">American Airlines (AA)</option>
                            <option value="DL" selected>Delta (DL)</option>
                            <option value="UA">United (UA)</option>
                            <option value="WN">Southwest (WN)</option>
                            <option value="B6">JetBlue (B6)</option>
                            <option value="AS">Alaska (AS)</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Fare Basis Code (optional)</label>
                        <input type="text" id="fareBasisCode" placeholder="e.g., Y14" maxlength="10">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Flight Options</label>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" id="isRefundable">
                            <span>Refundable</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="isBasicEconomy">
                            <span>Basic Economy</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="isHoliday">
                            <span>Holiday Period</span>
                        </label>
                    </div>
                </div>
                
                <!-- Advanced Options (Optional Overrides) -->
                <details style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e0e0e0;">
                    <summary style="cursor: pointer; font-weight: 600; color: #2c3e50; font-size: 1.05em; user-select: none;">
                        ‚öôÔ∏è Advanced Options (Optional - Override fare code parsing)
                    </summary>
                    <div style="margin-top: 15px;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Competitor Prices (comma-separated)</label>
                                <input type="text" id="competitorPrices" placeholder="e.g., 350,375,400">
                                <small style="color: #666; font-size: 0.85em;">Leave empty for default (no competitors)</small>
                            </div>
                            <div class="form-group">
                                <label>Total Seats on Aircraft</label>
                                <input type="number" id="totalSeats" value="180" min="50" max="500">
                            </div>
                        </div>
                    </div>
                </details>
                
                <button class="btn btn-primary" onclick="predictPrice()">
                    üîÆ Predict Price
                </button>
                
                <div class="model-info">
                    <h3>üìä Model Performance</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="stat-label">Model</span>
                            <span class="stat-value">XGBoost (91% R¬≤)</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">API Status</span>
                            <span class="stat-value" id="apiStatus">Checking...</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Endpoint</span>
                            <span class="stat-value">AWS ECS</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Features</span>
                            <span class="stat-value">23</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Results -->
            <div class="card result-card">
                <h2>üí∞ Price Prediction</h2>
                
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Analyzing flight data...</p>
                </div>
                
                <div id="results">
                    <div class="route-display">
                        <span class="airport" id="routeFrom">JFK</span>
                        <span class="arrow">‚úàÔ∏è ‚Üí</span>
                        <span class="airport" id="routeTo">LAX</span>
                    </div>
                    
                    <div class="price-display">
                        <div class="price-label">Predicted Price</div>
                        <div class="price-value" id="predictedPrice">$287.45</div>
                        <div class="price-range" id="priceRange">
                            Range: $244.33 - $330.57
                        </div>
                        <span class="confidence-badge confidence-high" id="confidence">
                            High Confidence
                        </span>
                    </div>
                    
                    <div class="factors">
                        <div class="factor-item">
                            <div class="factor-icon">üìÖ</div>
                            <div class="factor-label">Days Until Flight</div>
                            <div class="factor-value" id="daysUntil">17 days</div>
                        </div>
                        <div class="factor-item">
                            <div class="factor-icon">üí∫</div>
                            <div class="factor-label">Seat Availability</div>
                            <div class="factor-value" id="seatStatus">Available</div>
                        </div>
                        <div class="factor-item">
                            <div class="factor-icon">üìà</div>
                            <div class="factor-label">Demand Level</div>
                            <div class="factor-value" id="demandLevel">Medium</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // API base URL - empty string means same origin
        const API_BASE_URL = '';
        
        // Set default dates
        const today = new Date();
        const futureDate = new Date(today);
        futureDate.setDate(today.getDate() + 14);
        
        document.getElementById('searchDate').value = today.toISOString().split('T')[0];
        document.getElementById('flightDate').value = futureDate.toISOString().split('T')[0];
        
        // Distance mapping for routes
        const distances = {
            'JFK-LAX': 2475, 'LAX-JFK': 2475,
            'JFK-MIA': 1089, 'MIA-JFK': 1089,
            'JFK-ORD': 740, 'ORD-JFK': 740,
            'JFK-SFO': 2586, 'SFO-JFK': 2586,
            'LAX-SFO': 337, 'SFO-LAX': 337,
            'ATL-LAX': 1946, 'LAX-ATL': 1946,
            'ORD-LAX': 1745, 'LAX-ORD': 1745,
            'DFW-JFK': 1391, 'JFK-DFW': 1391,
        };
        
        // Update distance when airports change
        function updateDistance() {
            const from = document.getElementById('fromAirport').value;
            const to = document.getElementById('toAirport').value;
            const key = `${from}-${to}`;
            
            if (distances[key]) {
                document.getElementById('distance').value = distances[key];
            }
        }
        
        document.getElementById('fromAirport').addEventListener('change', updateDistance);
        document.getElementById('toAirport').addEventListener('change', updateDistance);
        
        // Check API health on load
        async function checkAPIHealth() {
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                const data = await response.json();
                if (data.status === 'healthy' && data.model_loaded) {
                    document.getElementById('apiStatus').textContent = '‚úÖ Online';
                    document.getElementById('apiStatus').style.color = '#00ff88';
                } else {
                    document.getElementById('apiStatus').textContent = '‚ö†Ô∏è Loading';
                    document.getElementById('apiStatus').style.color = '#ffc107';
                }
            } catch (error) {
                document.getElementById('apiStatus').textContent = '‚ùå Offline';
                document.getElementById('apiStatus').style.color = '#ff4444';
            }
        }
        
        checkAPIHealth();
        
        // Don't run prediction automatically on page load
        // predictPrice();
        
        async function predictPrice() {
            // Show loading
            document.getElementById('loading').classList.add('active');
            document.getElementById('results').classList.add('hidden');
            
            // Get input values
            const fromAirport = document.getElementById('fromAirport').value;
            const toAirport = document.getElementById('toAirport').value;
            const searchDate = document.getElementById('searchDate').value;
            const flightDate = document.getElementById('flightDate').value;
            const seatsRemaining = parseInt(document.getElementById('seatsRemaining').value);
            const distance = parseInt(document.getElementById('distance').value);
            const isBasicEconomy = document.getElementById('isBasicEconomy').checked;
            const isRefundable = document.getElementById('isRefundable').checked;
            const isHoliday = document.getElementById('isHoliday').checked;
            const departureHour = parseInt(document.getElementById('departureHour').value);
            const numSegments = parseInt(document.getElementById('numSegments').value);
            const durationMinutes = parseInt(document.getElementById('durationMinutes').value);
            const carrier = document.getElementById('carrier').value;
            const fareBasisCode = document.getElementById('fareBasisCode').value || 'Y14';
            
            // Get optional advanced fields
            const competitorPricesStr = document.getElementById('competitorPrices').value.trim();
            const competitorPrices = competitorPricesStr ? competitorPricesStr.split(',').map(p => parseFloat(p.trim())).filter(p => !isNaN(p)) : null;
            const totalSeats = parseInt(document.getElementById('totalSeats').value) || 180;
            
            // Derive isNonStop from numSegments
            const isNonStop = numSegments === 1;
            
            // Prepare API payload (updated for 23 features)
            const payload = {
                searchDate: searchDate,
                flightDate: flightDate,
                startingAirport: fromAirport,
                destinationAirport: toAirport,
                totalTravelDistance: distance,
                seatsRemaining: seatsRemaining,
                isBasicEconomy: isBasicEconomy,
                isRefundable: isRefundable,
                isNonStop: isNonStop,
                isHoliday: isHoliday,
                departureHour: departureHour,
                numSegments: numSegments,
                durationMinutes: durationMinutes,
                carrier: carrier,
                fareBasisCode: fareBasisCode || 'Y14',
                competitor_prices: competitorPrices,
                total_seats: totalSeats
            };
            
            try {
                // Call the FastAPI endpoint
                console.log('Calling API:', `${API_BASE_URL}/predict`);
                console.log('Payload:', payload);
                
                // Add timeout to prevent infinite hanging
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
                
                const response = await fetch(`${API_BASE_URL}/predict`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Response data:', data);
                
                if (data.success) {
                    const mlPrice = data.ml_base_price;
                    const dynamicPrice = data.dynamic_price;
                    const adjustment = data.total_adjustment;
                    const confidence = data.confidence;
                    const factors = data.factors;
                    
                    // Calculate price range (¬±15%)
                    const priceLow = dynamicPrice * 0.85;
                    const priceHigh = dynamicPrice * 1.15;
                    
                    // Calculate days until flight
                    const search = new Date(searchDate);
                    const flight = new Date(flightDate);
                    const daysUntil = Math.ceil((flight - search) / (1000 * 60 * 60 * 24));
                    
                    // Update UI
                    document.getElementById('routeFrom').textContent = fromAirport;
                    document.getElementById('routeTo').textContent = toAirport;
                    document.getElementById('predictedPrice').textContent = `$${dynamicPrice.toFixed(2)}`;
                    document.getElementById('priceRange').textContent = 
                        `ML Base: $${mlPrice.toFixed(2)} | Adjustment: ${adjustment > 0 ? '+' : ''}${adjustment.toFixed(1)}%`;
                    document.getElementById('daysUntil').textContent = `${daysUntil} days`;
                    
                    // Seat status
                    let seatStatus = 'Available';
                    if (seatsRemaining <= 2) seatStatus = 'Very Scarce';
                    else if (seatsRemaining <= 5) seatStatus = 'Scarce';
                    else if (seatsRemaining <= 10) seatStatus = 'Limited';
                    document.getElementById('seatStatus').textContent = seatStatus;
                    
                    // Demand level from factors
                    const demandFactor = parseFloat(factors.demand.replace('%', ''));
                    let demandLevel = 'Medium';
                    if (demandFactor > 10) demandLevel = 'High';
                    else if (demandFactor < -5) demandLevel = 'Low';
                    document.getElementById('demandLevel').textContent = demandLevel;
                    
                    // Confidence
                    const confidenceEl = document.getElementById('confidence');
                    confidenceEl.textContent = `${confidence} Confidence`;
                    if (confidence === 'High') {
                        confidenceEl.className = 'confidence-badge confidence-high';
                    } else {
                        confidenceEl.className = 'confidence-badge confidence-medium';
                    }
                    
                    // Hide loading, show results
                    document.getElementById('loading').classList.remove('active');
                    document.getElementById('results').classList.remove('hidden');
                } else {
                    throw new Error(data.detail || 'Prediction failed');
                }
                
            } catch (error) {
                console.error('API Error:', error);
                console.error('Error details:', error.message);
                alert('Error: ' + error.message + '\n\nCheck browser console (F12) for details.\n\nAPI: ' + API_BASE_URL);
                document.getElementById('loading').classList.remove('active');
                document.getElementById('results').classList.remove('hidden');
            }
        }
        
        // Initial prediction removed - now only runs on button click
        // predictPrice();
    </script>
</body>
</html>
